#!/bin/bash
#============================================================================
# Title       : mkapp
# Description : Creates ZIPAPP package
# Author      : Bart Sjerps <bart@dirty-cache.com>
# License     : GPLv3+
# ---------------------------------------------------------------------------

set -e
export gitdir=$(git rev-parse --show-toplevel) || exit 10
export progname=$(basename $gitdir)

die() { echo "$(basename $0) error: $@" >&2 ; exit 20 ; }

cat << EOF > "$gitdir"/src/dbcollect/lib/buildinfo.py
buildinfo = {
    'builddate': '$(date +"%Y-%m-%d %H:%M")',
    'tag': '$(git describe --dirty)',
    'packager': '$(git config --global user.name)'
}
EOF


makeapp() {
  echo "Creating $1"
  python3 -m zipapp \
	--output "$1" \
	--main dbcollect:main \
	--python "/usr/bin/env python" \
	 $gitdir/src/$progname
}

#============================================================================
# Main section - parsing options etc
# ---------------------------------------------------------------------------

export outdir=/tmp

while getopts ":d:" OPT; do
case "$OPT" in
  d) outdir=$OPTARG;;
  ?) die "Unknown option -$OPTARG" ;;
esac
done ; shift $(expr $OPTIND - 1)

makeapp  $outdir/$progname
ls -ld   $outdir/$progname
unzip -l $outdir/$progname
ls -l    $outdir/$progname
